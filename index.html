<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PyScript CSS -->
    <!-- <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script> -->
    <link rel="shortcut icon" href="images/icon.png" type="image/x-icon">

    <title>BootCampUTB - Dashboard</title>
    <script type="module" src="https://pyscript.net/tech-preview/pyscript.core/core.js"></script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/skins/color-1.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <link rel="stylesheet" href="css/style-switcher.css">
</head>
<body>
    <!-- Main container start -->
    <div class="main-container">
    <!-- Asaid start -->
        <div class="aside">
            <div class="logo">
                <a href="#dashboard1"><span class="typing"></span></a>
            </div>
            <div class="nav-toggler">
                <span></span>
            </div>
            <ul class="nav">
                <li><a href="#dashboard1" class="active"><i class="fa-solid fa-chart-simple"></i>Dashboard 1</a></li>
                <li><a href="#dashboard2"><i class="fa-solid fa-chart-pie"></i>Dashboard 2</a></li>
                <li><a href="#dashboard3"><i class="fa-solid fa-chart-line"></i>Dashboard 3</a></li>
            </ul>
        </div>
        <div class="rotate-logo"></div>
    </div>
    <!-- Sside end -->
    <!-- Main content start -->
    <div class="main-content">
        <!-- dashboard1 section start -->
        <section class="dashboard1 active section" id="dashboard1">
            <div class="container">
                
                <div class="row">
                    <!-- <h3>Dashboard 1</h3> -->
                    
                    <py-script>
                        import dash
                        from dash import dcc, html
                        from dash.dependencies import Input, Output
                        import plotly.express as px
                        import pandas as pd
                        import datetime
                
                        # Función para convertir semana en fecha aproximada (primer día de la semana)
                        def semana_a_fecha(anio, semana):
                            return datetime.datetime.strptime(f'{anio}-W{semana}-1', "%Y-W%U-%w").date()
                
                        # Paso 1: Conexión con las fuentes de datos (Archivos en Excel)
                        file_paths = [
                            'https://raw.githubusercontent.com/Deimerpajaro/Proyecto/refs/heads/main/DataBases/Datos_2019_356.xlsx',
                            'https://raw.githubusercontent.com/Deimerpajaro/Proyecto/refs/heads/main/DataBases/Datos_2020_356.xlsx',
                            'https://raw.githubusercontent.com/Deimerpajaro/Proyecto/refs/heads/main/DataBases/Datos_2021_356.xlsx',
                            'https://raw.githubusercontent.com/Deimerpajaro/Proyecto/refs/heads/main/DataBases/Datos_2022_356.xlsx',
                            'https://raw.githubusercontent.com/Deimerpajaro/Proyecto/refs/heads/main/DataBases/Datos_2023_356.xlsx'
                        ]
                
                        # Leer y concatenar todos los DataFrames
                        dfs = [pd.read_excel(file_path) for file_path in file_paths]
                        df_fuente = pd.concat(dfs, ignore_index=True)
                
                        # Paso 2: Transformaciones iniciales
                        df_fuente['FechaIncidente'] = df_fuente.apply(lambda row: semana_a_fecha(row['ANO'], row['SEMANA']), axis=1)
                
                        # Definir rangos de los ciclos de vida
                        bins = [0, 5, 11, 18, 26, 59, float('inf')]
                        labels = ["Primera Infancia", "Infancia", "Adolescencia", "Juventud", "Adultez", "Vejez"]
                        df_fuente['Ciclo_de_Vida'] = pd.cut(df_fuente['EDAD'], bins=bins, labels=labels, right=True, include_lowest=True)
                
                        # Filtrar los departamentos de interés
                        deptos_interes = ["BOLIVAR", "CORDOBA", "SUCRE", "SAN ANDRES"]
                        df_dpts = df_fuente[df_fuente["Departamento_ocurrencia"].isin(deptos_interes)]
                
                        # Paso 3: Crear gráficos
                
                        # Gráfico de calor (heatmap)
                        df_mp = df_dpts.groupby(['Departamento_ocurrencia', 'ANO']).confirmados.sum().unstack().fillna(0)
                        fig_mc = px.imshow(df_mp, labels=dict(x="Año", y="Departamento", color="Confirmados"),
                                           x=df_mp.columns, y=df_mp.index,
                                           title="Intentos de Suicidio en el Caribe Colombiano")
                
                        # Generación del dashboard
                        app = dash.Dash(__name__)
                        app.layout = html.Div(children=[
                            html.H1(children='Tableros Población'),
                            html.Div(children='Tableros interactivos sobre intentos de suicidio en el Caribe Colombiano'),
                            dcc.Graph(id='heatmap', figure=fig_mc),
                            html.Label('Selecciona el Año:'),
                            dcc.Dropdown(
                                id='dropdown-ano',
                                options=[{'label': str(ano), 'value': ano} for ano in df_dpts['ANO'].unique()] + [{'label': 'Todos los años', 'value': 'todos'}],
                                value='todos',
                                clearable=False
                            ),
                            html.Label('Selecciona el Sexo:'),
                            dcc.RadioItems(
                                id='radio-sexo',
                                options=[{'label': 'Hombre', 'value': 'M'}, {'label': 'Mujer', 'value': 'F'}, {'label': 'Ambos', 'value': 'todos'}],
                                value='todos'
                            ),
                            dcc.Graph(id='pie-chart'),
                            dcc.Graph(id='line-chart'),
                            dcc.Graph(id='bar-chart-1'),
                            dcc.Graph(id='bar-chart-2'),
                            dcc.Graph(id='bar-chart-3')
                        ])
                
                        @app.callback(
                            [Output('pie-chart', 'figure'),
                             Output('line-chart', 'figure'),
                             Output('bar-chart-1', 'figure'),
                             Output('bar-chart-2', 'figure'),
                             Output('bar-chart-3', 'figure')],
                            [Input('dropdown-ano', 'value'),
                             Input('radio-sexo', 'value')]
                        )
                        def update_graphs(selected_year, selected_sexo):
                            if selected_year == 'todos':
                                df_filtered = df_dpts
                            else:
                                df_filtered = df_dpts[df_dpts['ANO'] == selected_year]
                            
                            if selected_sexo != 'todos':
                                df_filtered = df_filtered[df_filtered['SEXO'] == selected_sexo]
                            
                            # Gráfico de torta (pie chart)
                            df_torta = df_filtered.groupby('Departamento_ocurrencia').confirmados.sum().reset_index()
                            fig_torta = px.pie(df_torta, values='confirmados', names='Departamento_ocurrencia', title='Distribución por Departamentos')
                
                            # Gráfico de líneas (line chart)
                            df1 = df_filtered.groupby(['Departamento_ocurrencia', 'FechaIncidente']).confirmados.sum().reset_index()
                            fig_lineas = px.line(df1, x="FechaIncidente", y="confirmados", color="Departamento_ocurrencia",
                                                 title=f'Tendencia de Incidentes de Suicidio en {selected_year}' if selected_year != 'todos' else 'Tendencia de Incidentes de Suicidio')
                            
                            # Gráfico de barras por estrato y departamento (bar chart)
                            df2 = df_filtered.groupby(['estrato', 'Departamento_ocurrencia']).confirmados.sum().reset_index()
                            fig_columna_1 = px.bar(df2, x="estrato", y="confirmados", color="Departamento_ocurrencia", barmode="group",
                                                   title=f'Casos por Estratos vs Departamentos en {selected_year}' if selected_year != 'todos' else 'Casos por Estratos vs Departamentos')
                            
                            # Gráfico de barras por sexo y fecha (bar chart)
                            df3 = df_filtered.groupby(['SEXO', 'FechaIncidente']).confirmados.sum().reset_index()
                            fig_barras_sexo = px.bar(df3, x='FechaIncidente', y='confirmados', color='SEXO', title=f'Tendencia Suicida según el Género en {selected_year}' if selected_year != 'todos' else 'Tendencia Suicida según el Género')
                            
                            # Gráfico de barras por ciclo de vida y departamento para mujeres (bar chart)
                            df_sexf = df_filtered[df_filtered["SEXO"] == "F"]
                            df_sexf['Ciclo_de_Vida'] = pd.Categorical(df_sexf['Ciclo_de_Vida'], categories=labels, ordered=True)
                            df4 = df_sexf.groupby(['Departamento_ocurrencia', 'Ciclo_de_Vida']).confirmados.sum().reset_index()
                            fig_columna_2 = px.bar(df4, x="Ciclo_de_Vida", y="confirmados", color="Departamento_ocurrencia", barmode="group",
                                                   title=f'Intentos de Suicidio en Mujeres por Ciclo de Vida en {selected_year}' if selected_year != 'todos' else 'Intentos de Suicidio en Mujeres por Ciclo de Vida')
                            
                            return fig_torta, fig_lineas, fig_columna_1, fig_barras_sexo, fig_columna_2
                
                            if __name__ == '__main__':
                            app.run_server(debug=True)
                    </py-script>
                </div>    
            </div>
        </section>
        <!-- dashboard1 section end -->
        <!-- dashboard2 section start -->
        <section class="dashboard2 section" id="dashboard2">
            <div class="container">
                <div class="row">
                    <!-- <h3>Dashboard 2</h3> -->
                    <img class="dash" src="images\d2.png" alt="" srcset="">
                </div>
            </div>
        </section> 
        <!-- dashboard2 section end -->
        <!-- dashboard3 section start -->
        <section class="dashboard3 section" id="dashboard3">
            <div class="container">
                <div class="row">
                    <!-- <h3>Dashboard 3</h3> -->
                    <img class="dash" src="images\d3.png" alt="" srcset="">
                </div>
                <!-- Portafolio item end -->
                </div>
            </div>
        </section>
        <!-- Portafolio section end -->
        <!-- Contact section start -->
        <section class="contact section" id="contact">
            <div class="container">
                <div class="row">
                    
                </div>
            </div>
        </section>
        <!-- Contact section end -->
        <!-- Contact section start -->
        <section class="end section" id="contact">
            <div class="container">
                <div class="logo">
                </div>
            </div>
        </section>
        <!-- Contact section end -->
    </div>
    <!-- Main content end -->

    </div>
    <!-- Main container end -->
    <!-- JS Files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.12/typed.min.js" referrerpolicy="no-referrer"></script>
    <script src="js/script.js"></script>
</body>
</html>